<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vditor@latest/dist/index.classic.css" />
<script src="https://cdn.jsdelivr.net/npm/vditor@latest/dist/index.min.js"></script>
<%- include('./components/header_createBlog.html') %>

<!-- vditor  ‰∏ä‰º†ÂõæÁâáÊúâbugÔºõ -->

<form class="blogCreate">
    <div class="header">
        <div class="header-left">
            <input id="blogCreate-title" type="text" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÊñáÁ´†Ê†áÈ¢ò">
            <hr />
            <div class="btn-group selTypes">
                <div class="dropdown-toggle " data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="iconfont icon-cecenidechenggongshuai"></i>
                    <input type="text" id="classificationsName" name="" value="" placeholder="ÈÄâÊã©ÂàÜÁ±ª"
                        style="width: 100px;font-size: 18px;" disabled>
                </div>
                <ul class="dropdown-menu">
                    <% for(let i =0 ; i< classifications.length; i++){%>
                    <li onclick="selClassifications('<%= classifications[i].name %>','<%= classifications[i]._id %>')">
                        <%= classifications[i].name%>
                    </li>
                    <%}%>
                    
                    <% if(req.session.user && req.session.user.isAdmin){%>
                    <li role="separator" class="divider"></li>
                    <li onclick="openAddClassification()"><a>Ê∑ªÂä†ÂàÜÁ±ª</a></li>
                    <% }%>
                </ul>
            </div>
        </div>
    </div>
    <div class="createBlog">
        <% if(editor&&editor =='markDown'){%>
        <div id="vditor"></div>
        <% }else{%>
        <div class="richTextEditor">
            <div id="richTextEditor"></div>
            <textarea id="contentText" style="width:100%; height:200px; opacity: 0;"></textarea>
        </div>

        <% }%>
    </div>
</form>

<div class="addClassification" style="display: none;">
    <form class="loginBody singinBody" action="/Classification" method="post">
        <i class="iconfont icon-guanbi1 closeLogin" onclick="closeAddClassification()"></i>
        <h4>Ê∑ªÂä†ÂàÜÁ±ª</h4>
        <div class="input-group">
            <input type="text" class="form-control" name="name" placeholder="ËØ∑ËæìÂÖ•ÂàÜÁ±ªÂêçÁß∞">
        </div>
        <div class="input-group">
            <textarea style="width:280px;margin-top:10px" class="form-control" name="describe" placeholder="ËØ∑ËæìÂÖ•ÂàÜÁ±ªÊèèËø∞"
                rows="3"></textarea>
        </div>
        <input class="btn btn-primary" type="submit" value="Ê∑ªÂä†" />
    </form>
</div>

<script>
    const vditor = new Vditor('vditor', {
        typewriterMode: true,
        height: 800,
        width: "100%",
        placeholder: "ËØ∑ËæìÂÖ•ÂçöÂÆ¢Ê≠£Êñá",
        hint: {
            emojiPath: 'https://cdn.jsdelivr.net/npm/vditor@latest/dist/images/emoji',
            // emojiTail: '<a href="https://hacpai.com/settings/function" target="_blank">ËÆæÁΩÆÂ∏∏Áî®Ë°®ÊÉÖ</a>',
            emoji: {
                'sd': 'üíî',
                "+1": "üëç",
                "-1": "üëé",
                "confounded": "üòñ",
                "confused": "üòï",
                "yum": "üòã",
                "crossed_fingers": "ü§û",
                "disappointed": "üòû",
                "disappointed_relieved": "üò•",
                "expressionless": "üòë",
                "drooling_face": "ü§§",
                "face_with_head_bandage": "ü§ï",
                "face_with_thermometer": "ü§í",
                "facepunch": "üëä",
                "fist": "‚úä",
                "fist_left": "ü§õ",
                "fist_oncoming": "üëä",
                "fist_raised": "‚úä",
                "fist_right": "ü§ú",
                "flushed": "üò≥",
                "frowning": "üò¶",
                "grimacing": "üò¨",
                "grin": "üòÅ",
                "grinning": "üòÄ",
                "kissing_closed_eyes": "üòö",
                "kissing_heart": "üòò",
                "nerd_face": "ü§ì",
                "kissing_smiling_eyes": "üòô",
                "relieved": "üòå",
                "rofl": "ü§£",
                "roll_eyes": "üôÑ",
                "scream": "üò±",
                "sleeping": "üò¥",
                "sleepy": "üò™",
                "slightly_frowning_face": "üôÅ",
                "slightly_smiling_face": "üôÇ",
                "smiley": "üòÉ",
                "sneezing_face": "ü§ß",
                "smirk": "üòè",
                "stuck_out_tongue_closed_eyes": "üòù",
                "stuck_out_tongue_winking_eye": "üòú",
                "sweat": "üòì",
                "sweat_drops": "üí¶",
                "sweat_smile": "üòÖ",
                "upside_down_face": "üôÉ",
                "zipper_mouth_face": "ü§ê",
                "unamused": "üòí",
                'j': 'https://unpkg.com/vditor@1.3.1/dist/images/emoji/j.png',
            },
        },
        tab: '\t',
        preview: {
            delay: 500,
            // hljs:{
            //     style:'native'
            // }
        },
        upload: {
            accept: 'image/*,.wav',
            token: 'test',
            url: '/tool/upload',
            max: "3 * 1024 * 1024",
            linkToImgUrl: '/tool/upload',
            format: (files, responseText) => {
                console.log(files, responseText);
            },
            success: (res) => {
                console.log(res);
            },

            filename: (name) => {
                return name.replace(/[^(a-zA-Z0-9\u4e00-\u9fa5\.)]/g, '').
                replace(/[\?\\/:|<>\*\[\]\(\)\$%\{\}@~]/g, '').
                replace('/\\s/g', '')
            },

        }
    });
</script>


<script>
    let classificationsId = "";

    function mdSwitch() {
        var mdValue = document.getElementById("md-area").value;
        var converter = new showdown.Converter();
        var html = converter.makeHtml(mdValue);
        document.getElementById("show-area").innerHTML = html;
    }

    function closeAddClassification() {
        $(".addClassification").css({
            "display": "none"
        })
    }

    function openAddClassification() {
        $(".addClassification").css({
            "display": "block"
        })
    }

    function selClassifications(name, id) {
        $("#classificationsName").val(name);
        classificationsId = id;
    }

    //ÂèëÂ∏ÉÊñáÁ´†
    function publishBlog(published) {
        let userId = "<%=req.session.user._id||''%>";
        let contentType = '<%=editor %>';
        let contert = vditor.getValue();
        if (!$('#blogCreate-title').val()) {
            alert("ÂçöÊñáÊ†áÈ¢ò‰∏çËÉΩ‰∏∫Á©∫");
            return
        }
        if (!contert) {
            alert("ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫");
            return
        }
        if (!classificationsId) {
            alert('ËØ∑ÈÄâÊã©ÂàÜÁ±ª');
            return
        }
        let data = {
            published,
            author: userId,
            title: $('#blogCreate-title').val(),
            content: contert,
            contentType: contentType,
            classifications: classificationsId,
        }
        $.ajax({
            type: 'POST',
            url: '/blog',
            data: data,
            success: (res) => {
                if (res.state == 0) {
                    vditor.clearCache()
                    window.location.href = "/";
                }
            },
        });
    }
</script>



<style>
    body {
        background-color: #fff;
    }

    .vditor-toolbar {
        background-color: #fff;
        border-bottom: 0px solid #d1d5da;
        padding: 8px 5px;
        border-radius: 0 0;
    }

    .vditor {
        border: 0px solid #d1d5da;
    }

    .vditor-textarea {
        background-color: #fafafa;
    }

    .vditor-toolbar svg {
        width: 16px;
        height: 16px;
    }
</style>